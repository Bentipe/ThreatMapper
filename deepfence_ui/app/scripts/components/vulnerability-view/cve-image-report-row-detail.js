/* eslint-disable jsx-a11y/no-noninteractive-element-interactions */
import React from 'react';
import { useDispatch } from 'react-redux';
import { Tooltip } from 'react-tippy';
import { dateTimeFormat } from '../../utils/time-utils';
import { DfTableV2 } from '../common/df-table-v2';
import {
  showModal,
  deleteScanActions,
  toaster,
} from '../../actions/app-actions';
import NotificationToaster from '../common/notification-toaster/notification-toaster';
import MORE_IMAGE from '../../../images/more.svg';

const CVEImageReportRowDetail = props => {
  const dispatch = useDispatch();

  const handleDeleteDialogScans = scanId => {
    const params = {
      dialogTitle: 'Delete Results ?',
      dialogBody: 'Are you sure you want to delete?',
      confirmButtonText: 'Yes',
      cancelButtonText: 'No',
      onConfirmButtonClick: () => deleteScans(scanId),
      contentStyles: {
        width: '375px',
      },
    };
    dispatch(showModal('DIALOG_MODAL', params));
  };

  const deleteScans = scanId => {
    const params = {
      scan_id: scanId,
      doc_type: 'cve',
      time_unit: 'all',
      number: '0',
    };
    const successHandler = response => {
      const { success, error: apiError } = response;
      if (success) {
        dispatch(toaster('Successfully deleted'));
        setTimeout(props.onDelete, 2000);
      } else {
        dispatch(toaster(`ERROR: ${apiError.message}`));
      }
    };
    const apiErrorHandler = () => {
      dispatch(toaster('Something went wrong'));
    };
    return dispatch(deleteScanActions(params)).then(
      successHandler,
      apiErrorHandler
    );
  };

  const { data, rowClickHandler, handleDownload, isToasterVisible } = props;

  return (
    <div>
      <DfTableV2
        data={data}
        onRowClick={row => rowClickHandler(row.original.scan_id)}
        enableSorting
        columns={[
          {
            Header: '',
            accessor: 'cve_scan_message',
            minWidth: 178,
            Cell: row => (
              <div className="truncate" title={row.value}>
                {row.value}
              </div>
            ),
          },
          {
            Header: 'Timestamp',
            accessor: row => dateTimeFormat(row.time_stamp),
            id: 'timestamp',
          },
          {
            Header: 'Status',
            accessor: 'action',
            minWidth: 120,
            Cell: cell => (
              <div
                className={
                  cell.value === 'COMPLETED'
                    ? 'status-success'
                    : 'status-failed'
                }
              >
                {cell.value}
              </div>
            ),
          },
          {
            Header: 'Active Containers',
            accessor: 'active_containers',
            maxWidth: 120,
            sortType: 'number',
          },
          {
            Header: 'Total',
            accessor: 'total',
            maxWidth: 80,
            sortType: 'number',
          },
          {
            Header: 'Score',
            accessor: row => (row.cve_score ? row.cve_score.toFixed(2) : 0),
            id: 'cveScore',
            maxWidth: 80,
            sortType: 'number',
          },
          {
            Header: 'Critical',
            accessor: 'severity.critical',
            Cell: row => (
              <div>
                <div className="cve-severity-box-wrap-critical value">
                  {row.value || 0}
                </div>
              </div>
            ),
            maxWidth: 80,
            sortType: 'number',
          },
          {
            Header: 'High',
            accessor: 'severity.high',
            Cell: row => (
              <div>
                <div className="cve-severity-box-wrap-high value">
                  {row.value || 0}
                </div>
              </div>
            ),
            maxWidth: 80,
            sortType: 'number',
          },
          {
            Header: 'Medium',
            accessor: 'severity.medium',
            Cell: row => (
              <div>
                <div className="cve-severity-box-wrap-medium value">
                  {row.value || 0}
                </div>
              </div>
            ),
            maxWidth: 80,
            sortType: 'number',
          },
          {
            Header: 'Low',
            accessor: 'severity.low',
            Cell: row => (
              <div>
                <div className="cve-severity-box-wrap-low value">
                  {row.value || 0}
                </div>
              </div>
            ),
            maxWidth: 80,
            sortType: 'number',
          },
          {
            Header: '',
            width: 60,
            accessor: 'scan_id',
            disableSortBy: true,
            Cell: cell => (
              <Tooltip
                arrow
                animation="shift"
                interactive
                trigger="click"
                hideOnClick
                position="bottom"
                theme="dark"
                zIndex={1}
                html={
                  <div className="table-row-actions-popup">
                    <i
                      className="fa fa-lg fa-download "
                      onClick={e => {
                        e.stopPropagation();
                        handleDownload(cell.value, cell.row.original.node_type);
                      }}
                    />
                    <i
                      className="fa fa-lg fa-trash-o"
                      style={{ color: 'red' }}
                      onClick={ev => {
                        ev.stopPropagation();
                        handleDeleteDialogScans(cell.value);
                      }}
                    />
                  </div>
                }
              >
                <img
                  src={MORE_IMAGE}
                  alt="more"
                  className="table-row-actions-target"
                  onClick={e => {
                    e.stopPropagation();
                  }}
                />
              </Tooltip>
            ),
          },
        ]}
      />
      {isToasterVisible && <NotificationToaster />}
    </div>
  );
};

export default CVEImageReportRowDetail;
