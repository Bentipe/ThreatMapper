/* eslint-disable */
import React, { useEffect, useState, useRef } from 'react';
import { Redirect } from 'react-router-dom';
import { useDispatch } from 'react-redux';
import {
  getCVEImageReportAction,
  saveImageReportTableStateAction,
} from '../../actions/app-actions';
import pollable from '../common/header-view/pollable';
import CVEImageReportRowDetail from './cve-image-report-row-detail';
import NodesFilter from '../../charts/nodes-filter';
import { DfTableV2 } from '../common/df-table-v2';

const CVEImageReport = props => {
  const arr = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9];
  const defaultExpandedRows = arr.reduce((acc, el) => {
    acc[el] = {};
    return acc;
  }, {});

  const columns = [
    {
      Header: 'Node Type',
      accessor: 'node_type',
      Cell: row => {
        let displayValue = row.value || 'container image';
        displayValue = displayValue.replace('_', ' ');
        return displayValue;
      },
      width: 30,
    },
    {
      Header: 'Node',
      accessor: 'node_name',
      width: 90,
      Cell: row => (
        <div className="truncate" title={row.value}>
          {row.value}
        </div>
      ),
    },
    {
      Header: 'Pass Status',
      accessor: row =>
        `${row.total_count - row.error_count}/${row.total_count} PASSED`,
      Cell: ({ row, value }) => (
        <div
          className={
            row?.original?.error_count === 0
              ? 'status-success'
              : 'status-failed'
          }
        >
          {value}
        </div>
      ),
      id: 'status',
    },
  ];

  const dispatch = useDispatch();
  const oldFilterValues = useRef(props.filtersValues);

  const [redirect, setRedirect] = useState(false);
  const [link, setLink] = useState('');
  const [rowCountValue, setRowCountValue] = useState(10);

  useEffect(() => {
    const {
      registerPolling,
      startPolling,
      dispatch,
      urlLocation: { search = '' } = {},
    } = props;
    registerPolling(pollParams => getCVEImageReport(pollParams));
    startPolling();
    if (search.length === 0) {
      // set save table page number to 0 if there is no search query
      // This resets the page number if user navigates to this page for the 1st time.
      // If user navigates from vulnerability details page, that sets a search query
      // and the page number is not reset. it will should previous page number.
      dispatch(saveImageReportTableStateAction({ pageNumber: 0 }));
    }
  }, []);

  useEffect(() => {
    return () => {
      // pollable: stop polling on unmount
      const { stopPolling } = props;
      stopPolling();
    };
  }, []);

  useEffect(() => {
    if (props.filterValues && oldFilterValues.current !== props.filterValues) {
      getCVEImageReport({
        filters: props.filterValues,
      });
      handlePageChange(0);
    }
    oldFilterValues.current = props.filterValues;
  }, [props.filtersValues]);

  const handleDownload = (scanId, nodeType) => {
    const { handleDownload } = props;
    return handleDownload({
      scanId,
      nodeType,
    });
  };

  const rowClickHandler = scanId => {
    setRedirect(true);
    setLink(`/vulnerability/details/${encodeURIComponent(scanId)}`);
  };

  const tableChangeHandler = (params = {}) => {
    // pollable: on any change in the DF Table params, update the polling params,
    // which will update and restart polling with new params.
    const { updatePollParams } = props;
    updatePollParams(params);
  };

  const getCVEImageReport = (pollParams = {}) => {
    const { dispatch, filterValues = {} } = props;

    const {
      page = 0,
      pageSize = 10,
      globalSearchQuery,
      alertPanelHistoryBound = props.alertPanelHistoryBound || {},
    } = pollParams;

    const tableFilters = pollParams.filters || filterValues;
    const nonEmptyFilters = Object.keys(tableFilters)
      .filter(key => tableFilters[key].length)
      .reduce((acc, key) => {
        // replacing back the dot which was removed redux-form as it considers that a nested field.
        acc[[key.replace('-', '.')]] = tableFilters[key];
        return acc;
      }, {});

    const params = {
      lucene_query: globalSearchQuery,
      // Conditionally adding number and time_unit fields
      ...(alertPanelHistoryBound.value
        ? { number: alertPanelHistoryBound.value.number }
        : {}),
      ...(alertPanelHistoryBound.value
        ? { time_unit: alertPanelHistoryBound.value.time_unit }
        : {}),
      node_filters: nonEmptyFilters,
      start_index: page ? page * pageSize : page,
      size: pageSize,
    };
    return dispatch(getCVEImageReportAction(params));
  };

  const handlePageChange = pageNumber => {
    tableChangeHandler({
      page: pageNumber,
    });
    dispatch(saveImageReportTableStateAction({ pageNumber }));
  };

  const setRowCount = e => {
    const rowCount = Number(e.target.value);
    setRowCountValue(rowCount);
  };

  const renderSubComponent = ({ row }) => {
    return (
      <CVEImageReportRowDetail
        data={row.original.scans}
        rowClickHandler={scanId => rowClickHandler(scanId)}
        handleDownload={(scanId, nodeType) => handleDownload(scanId, nodeType)}
        isToasterVisible={props.isToasterVisible}
        onDelete={pollParams => getCVEImageReport(pollParams)}
      />
    );
  };

  if (redirect) {
    return <Redirect to={link} />;
  }

  const {
    data = [],
    total,
    savedTablePageNumber = 0, // if page number is saved, pick it else start from 0
  } = props;

  const rowCounts = [
    {
      label: 10,
      value: 10,
    },
    {
      label: 25,
      value: 25,
    },
    {
      label: 50,
      value: 50,
    },
    {
      label: 100,
      value: 100,
    },
  ];
  return (
    <div>
      <div style={{ display: 'flex' }}>
        <div className="dataTables_length d-flex justify-content-start">
          <label htmlFor="true">
            {'Show '}
            <select
              style={{
                backgroundColor: '#252525',
                color: 'white',
                borderRadius: '4px',
                borderColor: '#252525',
              }}
              onChange={e => setRowCount(e)}
            >
              {rowCounts.map(el => (
                <option key={el.value} value={el.value}>
                  {el.label}
                </option>
              ))}
            </select>
            {' Entries'}
          </label>
        </div>
        <NodesFilter resourceType="cve" />
      </div>
      <DfTableV2
        data={data}
        columns={columns}
        renderRowSubComponent={({ row }) => renderSubComponent({ row })}
        showPagination
        manual
        defaultPageSize={rowCountValue}
        page={savedTablePageNumber}
        totalRows={total}
        onPageChange={pageNumber => handlePageChange(pageNumber)}
      />
    </div>
  );
};

export default pollable()(CVEImageReport);
